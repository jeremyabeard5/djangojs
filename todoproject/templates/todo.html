<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'todo' %}">To-Do App</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contact' %}">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'services' %}">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'tableau' %}">Tableau</a> <!-- New Tab -->
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1>To-Do List</h1>
        <form id="add-todo-form" method="post">
            {% csrf_token %}
            <input type="text" id="todo-title" class="form-control" placeholder="Enter a task" required>
            <button type="submit" class="btn btn-primary mt-2">Add</button>
        </form>
        <ul id="todo-list" class="list-group mt-4"></ul>
    </div>

    <script>
        // Fetch all todos
        function fetchTodos() {
            $.get('/get_todos/', function (data) {
                const todoList = $('#todo-list');
                todoList.empty();
                data.todos.forEach(todo => {
                    todoList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="${todo.is_completed ? 'text-decoration-line-through' : ''}">
                                ${todo.title}
                            </span>
                            <div>
                                <button class="btn btn-sm btn-success" onclick="toggleTodo(${todo.id})">
                                    ${todo.is_completed ? 'Undo' : 'Complete'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTodo(${todo.id})">Delete</button>
                            </div>
                        </li>
                    `);
                });
            });
        }

        // Add a todo
        $('#add-todo-form').on('submit', function (e) {
            e.preventDefault();
            const title = $('#todo-title').val();
            $.post('/add_todo/', { title: title }, function (data) {
                $('#todo-title').val('');
                fetchTodos();
            });
        });

        // Toggle a todo's completion status
        function toggleTodo(todoId) {
            $.post(`/update_todo/${todoId}/`, function () {
                fetchTodos();
            });
        }

        // Delete a todo
        function deleteTodo(todoId) {
            $.post(`/delete_todo/${todoId}/`, function () {
                fetchTodos();
            });
        }

        // Initial fetch
        fetchTodos();
    </script>

    <script>
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
    
        // Set up AJAX to include the CSRF token in the headers
        $.ajaxSetup({
            headers: { 'X-CSRFToken': csrftoken }
        });
    </script>

</body>
</html>
